// Backbone.Marionette v0.7.0
//
// Copyright (C)2011 Derick Bailey, Muted Solutions, LLC
// Distributed Under MIT License
//
// Documentation and Full License Available at:
// http://github.com/derickbailey/backbone.marionette
Backbone.Marionette=function(e,t,n){var r={};r.version="0.7.0",r.View=e.View.extend({getTemplateSelector:function(){var e;return this.options&&this.options.template?e=this.options.template:e=this.template,t.isFunction(e)&&(e=e.call(this)),e},close:function(){this.beforeClose&&this.beforeClose(),this.unbindAll(),this.remove(),this.onClose&&this.onClose(),this.trigger("close"),this.unbind()}}),r.ItemView=r.View.extend({constructor:function(){var e=i.call(arguments);r.View.prototype.constructor.apply(this,e),t.bindAll(this,"render"),this.initialEvents()},initialEvents:function(){this.collection&&this.bindTo(this.collection,"reset",this.render,this),this.model&&this.bindTo(this.model,"change",this.render,this)},serializeData:function(){var e;return this.model?e=this.model.toJSON():this.collection&&(e={items:this.collection.toJSON()}),e},render:function(){var e=this,t=n.Deferred(),i=this.getTemplateSelector(),s=this.serializeData();return this.beforeRender&&this.beforeRender(),this.trigger("item:before:render",e),n.when(s).then(function(s){var o=r.Renderer.render(i,s);n.when(o).then(function(n){e.$el.html(n),e.onRender&&e.onRender(),e.trigger("item:rendered",e),e.trigger("render",e),t.resolve()})}),t.promise()},close:function(){this.trigger("item:before:close"),r.View.prototype.close.apply(this,arguments),this.trigger("item:closed")}}),r.CollectionView=r.View.extend({constructor:function(){r.View.prototype.constructor.apply(this,arguments),t.bindAll(this,"addItemView","render"),this.initialEvents()},initialEvents:function(){this.collection&&(this.bindTo(this.collection,"add",this.addChildView,this),this.bindTo(this.collection,"remove",this.removeItemView,this),this.bindTo(this.collection,"reset",this.render,this))},addChildView:function(e){var t=this.getItemView();return this.addItemView(e,t)},render:function(){var e=this,t=n.Deferred(),r=[],i=this.getItemView();return this.beforeRender&&this.beforeRender(),this.trigger("collection:before:render",this),this.closeChildren(),this.collection&&this.collection.each(function(t){var n=e.addItemView(t,i);r.push(n)}),t.done(function(){this.onRender&&this.onRender(),this.trigger("collection:rendered",this)}),n.when(r).then(function(){t.resolveWith(e)}),t.promise()},getItemView:function(){var e=this.options.itemView||this.itemView;if(!e){var t=new Error("An `itemView` must be specified");throw t.name="NoItemViewError",t}return e},addItemView:function(e,t){var r=this,i=this.buildItemView(e,t);this.storeChild(i),this.trigger("item:added",i);var s=i.render();return n.when(s).then(function(){r.appendHtml(r,i)}),s},buildItemView:function(e,t){var n=new t({model:e});return n},removeItemView:function(e){var t=this.children[e.cid];t&&(t.close(),delete this.children[e.cid]),this.trigger("item:removed",t)},appendHtml:function(e,t){e.$el.append(t.el)},storeChild:function(e){this.children||(this.children={}),this.children[e.model.cid]=e},close:function(){this.trigger("collection:before:close"),this.closeChildren(),r.View.prototype.close.apply(this,arguments),this.trigger("collection:closed")},closeChildren:function(){this.children&&t.each(this.children,function(e){e.close()})}}),r.CompositeView=r.CollectionView.extend({constructor:function(e){r.CollectionView.apply(this,arguments),this.itemView=this.getItemView()},getItemView:function(){return this.itemView||this.constructor},render:function(){var e=this,t=n.Deferred(),r=this.renderModel();return n.when(r).then(function(r){e.$el.html(r),e.trigger("composite:model:rendered"),e.trigger("render");var i=e.renderCollection();n.when(i).then(function(){setTimeout(function(){t.resolve()},0)})}),t.done(function(){e.trigger("composite:rendered")}),t.promise()},renderCollection:function(){var e=r.CollectionView.prototype.render.apply(this,arguments);return e.done(function(){this.trigger("composite:collection:rendered")}),e.promise()},renderModel:function(){var e={};this.model&&(e=this.model.toJSON());var t=this.getTemplateSelector();return r.Renderer.render(t,e)}}),r.Region=function(e){this.options=e||{},t.extend(this,e);if(!this.el){var n=new Error("An 'el' must be specified");throw n.name="NoElError",n}},t.extend(r.Region.prototype,e.Events,{show:function(e,t){this.ensureEl(),this.close(),this.open(e,t),this.currentView=e},ensureEl:function(){if(!this.$el||this.$el.length==0)this.$el=this.getEl(this.el)},getEl:function(e){return n(e)},open:function(e,t){var r=this;t=t||"html",n.when(e.render()).then(function(){r.$el[t](e.el),e.onShow&&e.onShow(),e.trigger("show"),r.trigger("view:show",e)})},close:function(){var e=this.currentView;if(!e)return;e.close&&e.close(),this.trigger("view:closed",e),delete this.currentView},attachView:function(e){this.currentView=e}}),r.Layout=r.ItemView.extend({constructor:function(){this.vent=new e.Marionette.EventAggregator,e.Marionette.ItemView.apply(this,arguments),this.regionManagers={}},render:function(){return this.initializeRegions(),e.Marionette.ItemView.prototype.render.call(this,arguments)},close:function(){this.closeRegions(),e.Marionette.ItemView.prototype.close.call(this,arguments)},initializeRegions:function(){var n=this;t.each(this.regions,function(t,r){var i=new e.Marionette.Region({el:t,getEl:function(e){return n.$(e)}});n.regionManagers[r]=i,n[r]=i})},closeRegions:function(){var e=this;t.each(this.regionManagers,function(t,n){t.close(),delete e[n]}),this.regionManagers={}}}),r.AppRouter=e.Router.extend({constructor:function(t){e.Router.prototype.constructor.call(this,t);if(this.appRoutes){var n=this.controller;t&&t.controller&&(n=t.controller),this.processAppRoutes(n,this.appRoutes)}},processAppRoutes:function(e,n){var r,i,s,o,u=[],a=this;for(s in n)u.unshift([s,n[s]]);o=u.length;for(var f=0;f<o;f++)s=u[f][0],i=u[f][1],r=t.bind(e[i],e),a.route(s,i,r)}}),r.Application=function(e){this.initCallbacks=new r.Callbacks,this.vent=new r.EventAggregator,t.extend(this,e)},t.extend(r.Application.prototype,e.Events,{addInitializer:function(e){this.initCallbacks.add(e)},start:function(e){this.trigger("initialize:before",e),this.initCallbacks.run(this,e),this.trigger("initialize:after",e),this.trigger("start",e)},addRegions:function(e){var t,n;for(var i in e)e.hasOwnProperty(i)&&(t=e[i],typeof t=="string"?n=new r.Region({el:t}):n=new t,this[i]=n)}}),r.BindTo={bindTo:function(e,t,n,r){r=r||this,e.on(t,n,r),this.bindings||(this.bindings=[]),this.bindings.push({obj:e,eventName:t,callback:n,context:r})},unbindAll:function(){t.each(this.bindings,function(e){e.obj.off(e.eventName,e.callback)}),this.bindings=[]}},r.Callbacks=function(){this.deferred=n.Deferred(),this.promise=this.deferred.promise()},t.extend(r.Callbacks.prototype,{add:function(e){this.promise.done(function(t,n){e.call(t,n)})},run:function(e,t){this.deferred.resolve(e,t)}}),r.EventAggregator=function(e){t.extend(this,e)},t.extend(r.EventAggregator.prototype,e.Events,r.BindTo,{bindTo:function(e,t,n){r.BindTo.bindTo.call(this,this,e,t,n)}}),r.TemplateCache={templates:{},loaders:{},get:function(e){var t=this,r=n.Deferred(),i=this.templates[e];if(i)r.resolve(i);else{var s=this.loaders[e];s?r=s:(this.loaders[e]=r,this.loadTemplate(e,function(n){delete t.loaders[e],t.templates[e]=n,r.resolve(n)}))}return r.promise()},loadTemplate:function(e,t){var r=n(e).html();t.call(this,r)},clear:function(){var e=arguments.length;if(e>0)for(var t=0;t<e;t++)delete this.templates[arguments[t]];else this.templates={}}},r.Renderer={render:function(e,t){var i=this,s=n.Deferred(),o=r.TemplateCache.get(e);return n.when(o).then(function(e){var n=i.renderTemplate(e,t);s.resolve(n)}),s.promise()},renderTemplate:function(e,n){if(!e||e.length===0){var r="A template must be specified",i=new Error(r);throw i.name="NoTemplateError",i}var s=t.template(e,n);return s}};var i=Array.prototype.slice,s=r.View.extend;return r.Region.extend=s,r.Application.extend=s,t.extend(r.View.prototype,r.BindTo),t.extend(r.Application.prototype,r.BindTo),t.extend(r.Region.prototype,r.BindTo),r}(Backbone,_,window.jQuery||window.Zepto||window.ender);